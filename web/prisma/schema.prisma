datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String?         @unique
  emailVerified DateTime?
  password      String?
  image         String?
  onboarded     Boolean         @default(false)
  
  // Package/Subscription
  activePackageId String?
  packageStartDate DateTime?
  packageEndDate   DateTime?
  packageStatus    PackageStatus @default(TRIAL)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  accounts      Account[]
  sessions      Session[]
  onboarding    OnboardingData?
  customers     Customer[]
  
  // Financial documents
  invoices      Invoice[]
  quotations    Quotation[]
  sales         Sale[]
  purchases     Purchase[]
  
  // Transactions
  incomeRecords IncomeRecord[]
  expenses      Expense[]
  payments      Payment[]
  loans         Loan[]
  ownerEquity   OwnerEquity[]
  
  // Assets
  fixedAssets   FixedAsset[]
  digitalAssets DigitalAsset[]
  securities    Security[]
  
  package       Package? @relation(fields: [activePackageId], references: [id])
  
  @@index([email])
}

enum PackageStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

model Package {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  price       Float
  duration    Int      // in days
  features    Json     // Array of features
  limits      Json     // Usage limits (invoices, customers, etc)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       User[]
  
  @@index([isActive])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model OtpCode {
  id        String   @id @default(nanoid())
  email     String
  code      String
  purpose   String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model OnboardingData {
  id                   String   @id @default(cuid())
  userId               String   @unique
  fullName             String
  phoneNumber          String
  heardFrom            String
  referralCode         String?
  workTypes            String[]
  registrationType     String
  businessName         String?
  startDate            DateTime
  notificationsEnabled Boolean  @default(false)
  termsAccepted        Boolean  @default(true)
  
  // Bank details as JSON array
  bankDetails          Json?    // Array of {id, bankName, accountNumber, accountName, isDefault}
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Customer {
  id        String   @id @default(nanoid(12))
  userId    String
  name      String
  email     String?
  phone     String?
  
  customerRole CustomerRole @default(BUYER)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices   Invoice[]
  quotations Quotation[]
  sales      Sale[]
  purchases  Purchase[]  
  expenses   Expense[]   

  @@unique([userId, email, customerRole])
  @@index([userId])
  @@index([userId, customerRole])
  @@index([userId, phone])
}

enum CustomerRole {
  BUYER    
  SUPPLIER 
}

// ============================================
// QUOTATIONS
// ============================================

model Quotation {
  id              String @id @default(nanoid(12))
  quotationNumber String @unique
  userId          String

  customerId    String?
  customerName  String?
  customerEmail String?
  customerPhone String?

  title       String?
  description String?
  
  materials        Json?
  materialsTotal   Float @default(0)
  workmanship      Float @default(0)
  
  otherCosts       Json?
  otherCostsTotal  Float @default(0)
  
  includeVAT  Boolean @default(false)
  vatAmount   Float?
  totalAmount Float

  amountPaid Float @default(0)
  balance    Float

  status      QuotationStatus @default(DRAFT)
  validUntil  DateTime?
  issueDate   DateTime        @default(now())
  
  refundReason  String?
  refundDate    DateTime?
  refundAmount  Float?

  payments Payment[]
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, issueDate])
}

enum QuotationStatus {
  DRAFT
  SENT
  UNPAID
  PARTIALLY_PAID
  PAID
  EXPIRED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Invoice {
  id            String @id @default(nanoid(10))
  invoiceNumber String @unique
  userId        String

  customerId    String?
  customerName  String?
  customerEmail String?
  customerPhone String?

  title       String?
  description String?
  items       Json
  amount      Float
  
  includeVAT  Boolean @default(false)
  vatAmount   Float?
  totalAmount Float

  status    InvoiceStatus @default(DRAFT)
  issueDate DateTime      @default(now())
  dueDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  saleId String? @unique
  sale   Sale?   @relation(fields: [saleId], references: [id])
  convertedAt       DateTime?

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, issueDate])
}

enum InvoiceStatus {
  DRAFT
  SENT
  CONVERTED
  OVERDUE
  CANCELLED
}

model Sale {
  id            String @id @default(nanoid(10))
  receiptNumber String @unique
  userId        String

  sourceType  SaleSourceType
  invoiceId   String? @unique
  invoice     Invoice?
  
  customerId    String?
  customerName  String?
  customerEmail String?
  customerPhone String?

  title       String?
  description String?
  items       Json
  
  subtotal       Float  
  discountType   DiscountType?
  discountValue  Float? 
  discountAmount Float @default(0)
  
  includeVAT  Boolean @default(false)
  vatAmount   Float?
  totalAmount Float  
  
  deliveryCost       Float @default(0)
  otherSaleExpenses  Json? 
  totalSaleExpenses  Float @default(0)

  amountPaid Float @default(0)
  balance    Float

  status    SaleStatus @default(UNPAID)
  saleDate  DateTime   @default(now())
  
  refundReason  String?
  refundDate    DateTime?
  refundAmount  Float?
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  payments Payment[]

  @@index([userId])
  @@index([userId, status])
  @@index([userId, saleDate])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum SaleSourceType {
  DIRECT
  FROM_INVOICE
}

enum SaleStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
}

model Purchase {
  id             String @id @default(nanoid(10))
  purchaseNumber String @unique
  userId         String

  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  vendorName  String
  vendorEmail String?
  vendorPhone String?

  title       String?
  description String?
  items       Json
  
  otherCosts      Json?
  otherCostsTotal Float @default(0)
  
  subtotal    Float
  includeVAT  Boolean @default(false)
  vatAmount   Float?
  totalAmount Float

  amountPaid Float @default(0)
  balance    Float

  status       PurchaseStatus @default(UNPAID)
  purchaseDate DateTime       @default(now())
  
  refundReason  String?
  refundDate    DateTime?
  refundAmount  Float?
  
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  payments Payment[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, status])
  @@index([userId, purchaseDate])
  @@index([userId, customerId])
}

enum PurchaseStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
}

model Payment {
  id            String   @id @default(ulid())
  userId        String
  
  payableType   PayableType
  
  saleId        String?
  quotationId   String?
  purchaseId    String?
  incomeId      String?
  expensesId    String?
  loanId        String?
  
  amount        Float
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod
  category      PaymentCategory
  
  reference     String?
  notes         String?
  createdAt     DateTime @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sale      Sale?         @relation(fields: [saleId], references: [id], onDelete: Cascade)
  quotation Quotation?    @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  purchase  Purchase?     @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  income    IncomeRecord? @relation(fields: [incomeId], references: [id], onDelete: Cascade)
  expenses  Expense?      @relation(fields: [expensesId], references: [id], onDelete: Cascade)
  loan      Loan?         @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  @@index([userId, payableType])
  @@index([userId, saleId])
  @@index([userId, quotationId])
  @@index([userId, purchaseId])
  @@index([userId, loanId])
  @@index([userId, paymentDate])
}

enum PayableType {
  QUOTATION
  SALE
  PURCHASE
  OTHER_INCOME
  OTHER_EXPENSES
  LOAN
}

enum PaymentCategory {
  INCOME
  EXPENSE
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  MOBILE_MONEY
  CHEQUE
  OTHER
}

model IncomeRecord {
  id          String @id @default(ulid())
  userId      String
  
  mainCategory IncomeMainCategory
  subCategory  IncomeSubCategory
  customSubCategory String?
  
  grossAmount   Float  
  taxablePercentage Float?
  
  // Link to loan for interest income
  linkedLoanId String?
  
  description String?
  date        DateTime @default(now())
  
  isRefund        Boolean @default(false)
  refundReason    String?
  refundDate    DateTime?
  
  attachments Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, mainCategory])
  @@index([userId, date])
  @@index([userId, subCategory])
  @@index([userId, mainCategory, date])
  @@index([userId, isRefund])
  @@index([userId, linkedLoanId])
}

enum IncomeMainCategory {
  BUSINESS_PROFIT
  EMPLOYMENT_INCOME
  INVESTMENT_INCOME
  PROPERTY_INCOME
  DIGITAL_ASSETS
  TRUST_ESTATE_INCOME
  OTHER_INCOME
  EXEMPT_INCOME 
}

enum IncomeSubCategory {
  TRADE_PROFIT
  SERVICE_FEES
  COMMISSION
  ROYALTIES
  RENTAL_INCOME
  INTEREST_INCOME
  DIVIDENDS
  PRIZES_AWARDS
  REBATES_DISCOUNTS
  OTHER_BUSINESS_INCOME

  SALARY
  BONUS
  ALLOWANCES
  BENEFITS_IN_KIND
  PENSION
  SEVERANCE

  INVESTMENT_RETURN
  CAPITAL_GAINS
  STOCK_OPTIONS
  MUTUAL_FUNDS
  BONDS

  PROPERTY_RENTAL
  PROPERTY_LEASING
  PROPERTY_DISPOSAL

  CRYPTOCURRENCY_TRADING
  DIGITAL_ASSET_MINING
  NFT_SALES
  DIGITAL_SERVICES

  TRUST_DISTRIBUTION
  ESTATE_DISTRIBUTION

  GIFTS_RECEIVED
  DONATIONS_RECEIVED
  GRANTS
  COMPENSATION
  INSURANCE_PROCEEDS
  INHERITANCE
  CUSTOM

  RETURN_OF_CAPITAL
  SPECIFIC_EXEMPTIONS
}

model Expense {
  id          String @id @default(ulid())
  userId      String
  
  category    ExpenseCategory
  subCategory String? 
  
  amount      Float 
  description String
  date        DateTime @default(now())
  
  isDeductible        Boolean @default(true)
  deductionPercentage Int     @default(100)
  note                String?
  
  vendorName  String?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Link to loan for interest expense
  linkedLoanId String?
  
  isReturn         Boolean @default(false)
  returnReason     String?
  returnDate    DateTime?
  
  receipt     String?
  attachments Json?
  
  reference String?
  payments Payment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, category])
  @@index([userId, date])
  @@index([userId, isDeductible])
  @@index([userId, category, date])
  @@index([userId, isReturn])
  @@index([userId, customerId])
  @@index([userId, linkedLoanId])
}

enum ExpenseCategory {
  // Fully Deductible Business Expenses
  COST_OF_GOODS
  RENT_RATES
  UTILITIES
  SALARIES_WAGES
  REPAIRS_MAINTENANCE
  OFFICE_SUPPLIES
  SOFTWARE_SUBSCRIPTIONS
  PROFESSIONAL_FEES
  INSURANCE
  LICENSES_PERMITS
  ADVERTISING
  BANK_CHARGES
  TRAINING
  
  // Partially Deductible Business Expenses
  INTEREST_ON_DEBT
  BAD_DEBTS
  DONATIONS
  DEPRECIATION
  RESEARCH_DEVELOPMENT
  ENTERTAINMENT
  
  // Individual/Employee Expenses
  PERSONAL_EXPENSES
  RESIDENTIAL_RENT
  TRANSPORTATION
  
  // Non-Deductible Expenses
  FINES_PENALTIES
  BENEFITS_IN_KIND
  NON_APPROVED_PENSION
  PERSONAL_LIVING_EXPENSES
  
  // Other Expenses
  OTHER
}

// ============================================
// LOAN MODEL
// ============================================

model Loan {
  id             String   @id @default(nanoid(12))
  userId         String
  loanNumber     String   @unique
  loanType       LoanType

  // Party details (borrower OR lender depending on loan type)
  partyName  String
  partyEmail String?
  partyPhone String?

  principalAmount Float
  interestRate    Float // Annual interest rate percentage

  // Loan charges/fees
  processingFee  Float @default(0)
  managementFee  Float @default(0)
  insuranceFee   Float @default(0)
  otherCharges   Float @default(0)
  totalCharges   Float @default(0)

  startDate DateTime
  endDate   DateTime? // Calculated field based on startDate + term + termUnit
  term      Int? // Duration number (e.g., 12)
  termUnit  TermUnit @default(MONTHS) // Unit for the term (days, months, years)

  paymentFrequency PaymentFrequency

  currentBalance     Float
  totalPaid          Float @default(0)
  totalInterestPaid  Float @default(0)

  status LoanStatus @default(ACTIVE)

  purpose    String?
  collateral String?
  notes      String?

  attachments Json?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, loanType])
  @@index([userId, status])
  @@index([userId, startDate])
}

enum LoanType {
  RECEIVABLE 
  PAYABLE 
}

enum PaymentFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  ONE_TIME
}

enum TermUnit {
  DAYS
  MONTHS
  YEARS
}

enum LoanStatus {
  ACTIVE
  PAID_OFF
  DEFAULTED
  RESTRUCTURED
  WRITTEN_OFF
}

// ============================================
// OWNER EQUITY MODEL (For Ltd/PLC only)
// ============================================

model OwnerEquity {
  id              String @id @default(ulid())
  userId          String
  
  type            EquityType
  amount          Float
  date            DateTime @default(now())
  
  shareholderName String?  // For companies with multiple shareholders
  description     String?
  reference       String?
  
  notes           String?
  attachments     Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, type])
  @@index([userId, date])
}

enum EquityType {
  CAPITAL_INJECTION  // Money put into the business
  OWNER_DRAWING      // Money taken out by owner
  DIVIDEND           // Profit distribution to shareholders
}

// ============================================
// ASSETS
// ============================================

model FixedAsset {
  id          String @id @default(nanoid(12))
  userId      String
  
  name        String
  category    FixedAssetCategory
  
  acquisitionCost  Float
  acquisitionDate  DateTime
  currentValue     Float
  depreciationRate Float?
  residualValue    Float  @default(0)
  
  valueHistory Json?
  
  disposalDate     DateTime?
  disposalProceeds Float?
  capitalGain      Float?
  
  description String?
  status      AssetStatus @default(ACTIVE)
  attachments Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, status])
  @@index([userId, category])
  @@index([userId, acquisitionDate])
}

enum FixedAssetCategory {
  LAND
  BUILDING
  VEHICLE
  MACHINERY
  EQUIPMENT
  FURNITURE
  COMPUTER
  OTHER
}

enum AssetStatus {
  ACTIVE
  DISPOSED
  WRITTEN_OFF
}

model DigitalAsset {
  id          String @id @default(nanoid(12))
  userId      String
  
  type        DigitalAssetType
  name        String
  symbol      String?
  
  quantity     Float
  averageCost  Float
  currentValue Float
  
  transactions Json[]
  
  totalGains  Float @default(0)
  totalLosses Float @default(0)
  
  description String?
  status      AssetStatus @default(ACTIVE)
  attachments Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, type])
  @@index([userId, status])
}

enum DigitalAssetType {
  CRYPTOCURRENCY
  NFT
  DOMAIN_NAME
  DIGITAL_ART
  GAME_ASSET
  OTHER
}

model Security {
  id          String @id @default(nanoid(12))
  userId      String
  
  type        SecurityType
  symbol      String
  name        String
  exchange    String?
  
  quantity     Float
  averageCost  Float
  currentValue Float
  
  transactions Json[]
  
  dividendsReceived Float @default(0)
  interestReceived  Float @default(0)
  totalGains        Float @default(0)
  totalLosses       Float @default(0)
  
  status      AssetStatus @default(ACTIVE)
  description String?
  attachments Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, type])
  @@index([userId, status])
}

enum SecurityType {
  STOCK
  BOND
  MUTUAL_FUND
  ETF
  TREASURY_BILL
  OTHER
}